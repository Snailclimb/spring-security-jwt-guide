
# spring-security-jwt-guide

**å¦‚æœå›½å†…è®¿é—®ç¼“æ…¢çš„è¯ï¼Œå¯ä»¥é€šè¿‡ç äº‘æŸ¥çœ‹ï¼š** https://gitee.com/SnailClimb/spring-security-jwt-guide ã€‚

## å‰è¨€

[Spring Security](https://spring.io/projects/spring-security ) æ˜¯ Spring å…¨å®¶æ¡¶ä¸­éå¸¸å¼ºå¤§çš„ä¸€ä¸ªç”¨æ¥åšèº«ä»½éªŒè¯ä»¥åŠæƒé™æ§åˆ¶çš„æ¡†æ¶ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°æ‰©å±•å®ƒæ¥æ»¡è¶³æˆ‘ä»¬å½“å‰ç³»ç»Ÿå®‰å…¨æ€§è¿™æ–¹é¢çš„éœ€æ±‚ã€‚

ä½†æ˜¯ Spring Security ç›¸æ¯”äºå…¶ä»–ä¸€äº›æŠ€æœ¯æ¯”å¦‚ JPA æ¥è¯´æ›´éš¾ä¸Šæ‰‹ï¼Œå¾ˆå¤šäººåˆå­¦çš„æ—¶å€™å¾ˆéš¾é€šè¿‡çœ‹è§†é¢‘æˆ–è€…æ–‡æ¡£å‘å°±å¾ˆå¿«èƒ½ç‹¬ç«‹å†™ä¸€ä¸ª Demo å‡ºæ¥ï¼Œäºæ˜¯åé¢å¯èƒ½å°±æ”¾å¼ƒäº†å­¦ä¹ è¿™ä¸ªä¸œè¥¿ã€‚

åˆšæ¥å…¬å¸çš„æ—¶å€™çš„å…¥èŒåŸ¹è®­å®æˆ˜é¡¹ç›®ä»¥åŠç°åœ¨æ­£åœ¨åšçš„é¡¹ç›®éƒ½ç”¨åˆ°äº† Spring Security è¿™ä¸ªå¼ºå¤§çš„å®‰å…¨éªŒè¯æ¡†æ¶ï¼Œå¯ä»¥çœ‹å‡ºè¿™ä¸ªæ¡†æ¶åœ¨èº«ä»½éªŒè¯ä»¥åŠæƒé™éªŒè¯é¢†åŸŸå¯ä»¥è¯´åº”è¯¥æ˜¯æ¯”è¾ƒä¸é”™çš„é€‰æ‹©ã€‚ç”±äºä¹‹å‰ç»å†é¡¹ç›®çš„è¿™éƒ¨åˆ†æ¨¡å—éƒ½ä¸æ˜¯è‡ªå·±åšçš„ï¼Œæ‰€ä»¥å¯¹äº Spring Security å¹¶ä¸æ˜¯å¤ªç†Ÿæ‚‰ã€‚äºæ˜¯è‡ª/å·±æŠ½æ—¶é—´å¯¹è¿™éƒ¨åˆ†çŸ¥è¯†å­¦ä¹ äº†ä¸€ä¸‹ï¼Œå¹¶å®ç°äº†ä¸€ä¸ªç®€å•çš„ Demo ã€‚è¿™ä¸ª Demo ä¸»è¦ç”¨åˆ°äº† **Spring Security** å’Œ **Spring Boot** è¿™ä¸¤é—¨æŠ€æœ¯ï¼Œå¹¶ä¸”æ‰€æœ‰çš„ä¾èµ–é‡‡ç”¨çš„éƒ½æ˜¯æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬ã€‚åˆæ¬¡ä¹‹å¤–ï¼Œè¿™ä¸ªé¡¹ç›®è¿˜ç”¨åˆ°äº† JPA è¿™é—¨æŠ€æœ¯ã€‚

ç”±äºè‡ªå·±çš„èƒ½åŠ›ä»¥åŠæ—¶é—´æœ‰é™ï¼Œæ‰€ä»¥ä¸€å®šè¿˜æœ‰å¾ˆå¤šå¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ï¼Œæœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥ä¸€èµ·å®Œå–„ï¼ŒæœŸå¾…ä½ çš„ PRã€‚

## ä»‹ç»

**é¡¹ç›®ç”¨åˆ°çš„ä¸€äº›æ¡†æ¶/æœåŠ¡ï¼š**

- **æ•°æ®åº“**ï¼š H2å†…å­˜æ•°æ®åº“ï¼Œæ— éœ€æ‰‹åŠ¨å®‰è£…ã€‚
- **ç¼“å­˜**ï¼š Redis
- **æƒé™æ¡†æ¶** ï¼šSpring Security
- **ORMæ¡†æ¶** ï¼šJPA ï¼ˆä½SQLï¼‰
- **æ¥å£æ–‡æ¡£** ï¼š  swaggerã€‚åœ¨çº¿ API æ–‡æ¡£åœ°å€ï¼š[http://localhost:9333/api/swagger-ui/](http://localhost:9333/api/swagger-ui/) ã€‚ç›®å‰ä½¿ç”¨ knife4j å¢å¼ºäº† swagger åŠŸèƒ½ï¼Œåœ°å€ï¼š [http://localhost:9333/api/doc.html#/home](http://localhost:9333/api/doc.html#/home) ï¼ˆæ¨èğŸ‘ï¼‰

**ä½ èƒ½ä»è¿™ä¸ªé¡¹ç›®ä¸­å­¦ä¹ åˆ°ä»€ä¹ˆï¼Ÿ**

1. Spring Security +JWT å®ç°ç™»å…¥ç™»å‡ºä»¥åŠæƒé™æ ¡éªŒ
2. JPA å®ç°å®¡è®¡åŠŸèƒ½ã€å¤šå¯¹å¤šçš„æ˜ å°„å…³ç³»å¦‚ä½•é€šè¿‡å…³è”è¡¨å®ç°

## æ•™ç¨‹

1. [é¡¹ç›®è®²è§£/åˆ†æ](./docs/SpringSecurityä»‹ç».md) ï¼ˆå†…å®¹å¾…é‡æ„ï¼‰
2. [swagger3.0æ•´åˆ](./docs/swagger.md) 

## ä»£åŠ

- [x] å¢åŠ H2å†…å­˜æ•°æ®åº“æ”¯æŒï¼Œæ— é¡»MySQLï¼Œä¸€é”®å¯åŠ¨é¡¹ç›®å¯åŠ¨åè®¿é—® `http://{host}:9333/h2-console/` (æ•°æ®åº“ url åœ°å€ã€ç”¨æˆ·åå’Œå¯†ç éƒ½åœ¨  `application.properties` é…ç½®æ–‡ä»¶ä¸­)
- [x] å¢åŠ Swaggerï¼Œæ–¹ä¾¿è°ƒç”¨æ¥å£
- [x] å¼‚å¸¸å¤„ç†éƒ¨åˆ†ä»£ç é‡æ„ï¼Œä¼˜åŒ–è¿”å›ç»“æ„
- [x] æ–°å»ºä¸€ä¸ªroleè¡¨ï¼Œç„¶åé€šè¿‡æ–°å»ºä¸€ä¸ªrole_userè¡¨çš„å½¢å¼ï¼Œå°†ç”¨æˆ·ä¸è§’è‰²å…³è”èµ·æ¥
- [x] æ–‡ä»¶ç»“æ„é‡æ„
- [x] å¢åŠ jpaå®¡è®¡åŠŸèƒ½
- [x] loginï¼ˆç™»å½•ï¼‰æ¥å£åœ¨controllerå±‚æš´éœ²å‡ºæ¥
- [x] ç™»å‡ºåŠŸèƒ½ï¼šredisä¿å­˜tokenä¿¡æ¯ï¼ˆkey->user id,value->tokenï¼‰ï¼Œç™»å‡ºåå°† redisä¸­çš„tokenä¿¡æ¯åˆ é™¤
- [x] é‡æ–°ç™»å½•å°†ä¸Šä¸€æ¬¡ç™»å½•ç”Ÿæˆçš„tokenå¼„å¤±æ•ˆï¼ˆè§£å†³æœªè¿‡æœŸçš„tokenè¿˜æ˜¯å¯ä»¥ç”¨çš„é—®é¢˜ï¼‰ï¼šé‡æ–°ç™»å½•ä¼šå°† redis ä¸­ä¿å­˜çš„ token ä¿¡æ¯è¿›è¡Œæ›´æ–°
- [ ] é‡æ„è¯¦è§£æ–‡ç« 

## é¡¹ç›®æ¦‚è§ˆ

ä¸ºäº†åŒºåˆ†ï¼Œæˆ‘æŠŠ Spring Securityç›¸å…³çš„éƒ½å•ç‹¬æ”¾åœ¨äº†ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢ã€‚

![](./pictures/structure.png)


## å¦‚ä½•è¿è¡Œé¡¹ç›®

1. git clone https://github.com/Snailclimb/spring-security-jwt-guide.git
2. æ‰“å¼€é¡¹ç›®å¹¶ä¸”ç­‰å¾… Maven ä¸‹è½½å¥½ç›¸å…³ä¾èµ–ã€‚å»ºè®®ä½¿ç”¨ Intellij IDEA æ‰“å¼€ï¼Œå¹¶ç¡®ä¿ä½ çš„ Intellij IDEA ä¸‹è½½äº† lombok æ’ä»¶ã€‚
3. ä¸‹è½½ redis å¹¶`application.yaml`ä¸­redisçš„é…ç½®
4. è¿è¡Œé¡¹ç›®ï¼ˆç›¸å…³æ•°æ®è¡¨ä¼šè¢«è‡ªåŠ¨åˆ›å»ºï¼Œä¸äº†è§£çš„çœ‹ä¸€ä¸‹ JPAï¼‰

## ç¤ºä¾‹

### 1.æ³¨å†Œä¸€ä¸ªè´¦å·

**URL:**

`POST http://localhost:9333/api/users/sign-up`

**RequestBody:**

```json
{"userName":"123456","fullName":"shuangkou","password":"123456"}
```

![æ³¨å†Œ](./pictures/sign-up.png)

æ–°æ³¨å†Œçš„ç”¨æˆ·é»˜è®¤ç»‘å®šçš„è§’è‰²ä¸ºï¼šç”¨æˆ·ï¼ˆUSERï¼‰å’Œç®¡ç†è€…ï¼ˆMANAGERï¼‰ã€‚

### 2.ç™»å½•

**URL:**

`POST http://localhost:9333/api/auth/login`

**RequestBody:**

```json
{"username": "123456", "password": "123456","rememberMe":true}
```

![ç™»å½•](./pictures/login.png)


### 3.ä½¿ç”¨æ­£ç¡® Token è®¿é—®éœ€è¦è¿›è¡Œèº«ä»½éªŒè¯çš„èµ„æº

æˆ‘ä»¬ä½¿ç”¨ GET è¯·æ±‚è®¿é—® `/api/users`ï¼Œè¿™ä¸ªæ¥å£çš„è®¿é—®æƒé™æ˜¯

```java
@PreAuthorize("hasAnyRole('ROLE_USER','ROLE_MANAGER','ROLE_ADMIN')")
```

![Access resources that require authentication](./pictures/access-resources-that-require-authentication.png)

### 4.ä¸å¸¦ Token æˆ–è€…ä½¿ç”¨æ— æ•ˆ Token è®¿é—®

æˆ‘ä»¬ä½¿ç”¨ GET è¯·æ±‚è®¿é—® `/api/users`ï¼Œä½†æ˜¯ä¸å¸¦tokenæˆ–è€…å¸¦ä¸Šæ— æ•ˆtokenã€‚


![Access resources that require authentication without token or with invalid token](./pictures/access-resources-that-require-authentication2.png)

### 5.å¸¦äº†æ­£ç¡®Tokenä½†æ˜¯è®¿é—®æƒé™

æˆ‘ä»¬ä½¿ç”¨ DELETE è¯·æ±‚è®¿é—® `/api/users?username=xxx`ï¼Œæºå¸¦æœ‰æ•ˆçš„ token ï¼Œä½†æ˜¯ token çš„è®¿é—®æƒé™ä¸å¤Ÿã€‚

![](./pictures/not-have-enough-permission.png)

## å‚è€ƒ

- https://dev.to/keysh/spring-security-with-jwt-3j76
